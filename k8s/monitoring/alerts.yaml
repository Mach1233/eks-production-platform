# Prometheus Alert Rules for FinTrack
# Basic alerts: high CPU, pod crashes, pod restarts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: fintrack-alerts
  namespace: monitoring
  labels:
    release: prometheus # Must match kube-prometheus-stack release name
spec:
  groups:
    - name: fintrack.rules
      rules:
        # High CPU usage (>80% for 5 minutes)
        - alert: HighCPUUsage
          expr: |
            (sum(rate(container_cpu_usage_seconds_total{namespace="fintrack"}[5m])) by (pod)
            / sum(kube_pod_container_resource_requests{namespace="fintrack", resource="cpu"}) by (pod))
            > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} CPU usage is above 80% for 5 minutes."

        # Pod CrashLoopBackOff
        - alert: PodCrashLooping
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace="fintrack"}[15m]) > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.pod }} is crash-looping"
            description: "Pod {{ $labels.pod }} has been restarting in the last 15 minutes."

        # Pod not ready for 5 minutes
        - alert: PodNotReady
          expr: |
            kube_pod_status_ready{namespace="fintrack", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} is not ready"
            description: "Pod {{ $labels.pod }} has not been ready for 5 minutes."

        # High memory usage (>80%)
        - alert: HighMemoryUsage
          expr: |
            (sum(container_memory_working_set_bytes{namespace="fintrack"}) by (pod)
            / sum(kube_pod_container_resource_requests{namespace="fintrack", resource="memory"}) by (pod))
            > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory on {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} memory usage above 80% for 5 minutes."
